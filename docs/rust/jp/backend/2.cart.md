# cart サービス

cart サービスは、「Online Boutique」でユーザーがカートに追加した商品の情報を管理します。

## proto ファイル

gRPC の [Protocol Buffers](https://protobuf.dev/) の定義が行われている proto ファイルは、次の場所にあります。

[/src/cartservice/protos/Cart.proto](/src/cartservice/protos/Cart.proto)

```
syntax = "proto3";

package hipstershop;

// -----------------Cart service-----------------

service CartService {
    rpc AddItem(AddItemRequest) returns (Empty) {}
    rpc GetCart(GetCartRequest) returns (Cart) {}
    rpc EmptyCart(EmptyCartRequest) returns (Empty) {}
}

message CartItem {
    string product_id = 1;
    int32  quantity = 2;
}

message AddItemRequest {
    string user_id = 1;
    CartItem item = 2;
}

message EmptyCartRequest {
    string user_id = 1;
}

message GetCartRequest {
    string user_id = 1;
}

message Cart {
    string user_id = 1;
    repeated CartItem items = 2;
}

message Empty {}
```

「CartService」には、「AddItem」、「GetCart」、「EmptyCart」という３つの RPC が定義されているので、サービスは、これらの RPC を実装する必要があります。

## proto ファイルのビルド

「build.rs」には、「[tonic-build](https://github.com/hyperium/tonic/tree/master/tonic-build)」による proto ファイルから Rust のソースコードの生成が記述されています。

https://github.com/mnitta220/microservices-demo-rust/blob/d9e95f15b123a641a6b11023e24461778e66a641/src/productcatalogservice/build.rs#L1-L7

ビルドされた Rust のソースコードは、以下の場所に出力されます。

/src/productcatalogservice/target/debug/build/productcatalogservice-xxxxxxxxxxxxxxxx/out/hipstershop.rs  
（「xxxxxxxxxxxxxxxx」の箇所は不定）  
このファイルは、自動で生成されるので、ソースコード管理する必要はありません。Kubernetes で実行する場合は、[Dockerfile](/src/productcatalogservice/Dockerfile) の中で、ビルドを行うように記述されています。

## サービスの実装

https://github.com/mnitta220/microservices-demo-rust/blob/d9e95f15b123a641a6b11023e24461778e66a641/src/productcatalogservice/src/main.rs#L1-L71

製品の情報は、「[products.json](/src/productcatalogservice/products.json)」という JSON ファイルに指定されています。このファイルを読み込んで「PRODUCT_LIST」という OnceCell&lt;Vec&lt;Product&gt;&gt; の static に保持しています。

```rust
static PRODUCT_LIST: OnceCell<Vec<Product>> = OnceCell::new();
```

## RPC の実装

RPC の実装は、service.rs で行っています。

https://github.com/mnitta220/microservices-demo-rust/blob/d9e95f15b123a641a6b11023e24461778e66a641/src/productcatalogservice/src/service.rs#L1-L60

<br>

> productcatalog service の Rust への書き換えは、次の記事の内容を参考にさせていただきました。そのまま使わせていただいた箇所もあります。<br>「[Google が提供している microservices-demo の一部を Rust 実装に置き換えて Amazon EKS にデプロイしてみた](https://tech.dentsusoken.com/entry/2023/12/22/Google%E3%81%8C%E6%8F%90%E4%BE%9B%E3%81%97%E3%81%A6%E3%81%84%E3%82%8Bmicroservices-demo%E3%81%AE%E4%B8%80%E9%83%A8%E3%82%92Rust%E5%AE%9F%E8%A3%85%E3%81%AB%E7%BD%AE%E3%81%8D%E6%8F%9B%E3%81%88%E3%81%A6Amazon_EK)」
